<!-- ä¿®å¤åçš„ HTMLï¼Œåˆ é™¤é’“ç‚¹åŠŸèƒ½ä¼˜åŒ– -->
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é’“é±¼å‚è°‹</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom, #b3e5fc, #e0f7fa);
      color: #333;
    }
    $1padding: 20px;
      padding-bottom: 40px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 28px;
      color: #00796b;
      text-shadow: 1px 1px 2px #b2dfdb;
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }
    .data-line {
      margin: 8px 0;
      font-size: 18px;
    }
    .button {
      display: block;
      width: 100%;
      padding: 14px;
      background: #00796b;
      color: white;
      text-align: center;
      border-radius: 12px;
      font-size: 18px;
      margin-top: 16px;
      text-decoration: none;
      transition: background 0.3s ease;
    }
    .button:hover {
      background: #004d40;
    }
    .suggestion {
      margin-top: 16px;
      font-size: 18px;
      font-weight: bold;
      color: #004d40;
      white-space: pre-line;
    }
    .forecast-day {
      background: #f9f9f9;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .forecast-day p {
      margin: 6px 0;
      line-height: 1.5;
    }
    .forecast h2 {
      font-size: 20px;
      color: #00695c;
      margin-bottom: 10px;
    }
    #map {
      height: 300px;
      border-radius: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ£ é’“é±¼å‚è°‹</h1>
    <div class="card">
      <div class="data-line" id="date"></div>
      <div class="data-line" id="location"></div>
      <div class="data-line" id="weather"></div>
      <div class="data-line" id="temp"></div>
      <div class="data-line" id="wind"></div>
      <div class="data-line" id="pressure"></div>
      <div class="suggestion" id="advice"></div>
      <div class="data-line" id="dressIndex"></div>
      <a href="#" class="button" onclick="getWeather()">ğŸ”„ åˆ·æ–°æ•°æ®</a>
    </div>

    <div class="card forecast">
      <h2>ğŸ“† æœªæ¥ä¸‰å¤©é’“é±¼è¶‹åŠ¿é¢„æµ‹</h2>
      <div id="forecastContent"></div>
    </div>

    <div class="card">
      <h2>ğŸ“ æˆ‘çš„é’“ç‚¹æ”¶è—</h2>
      <div id="map"></div>
    </div>

    <div class="card">
  <h2>ğŸ“˜ é’“é±¼å°ç™¾ç§‘ <button onclick="toggleContent(this)">å±•å¼€</button></h2>
  <div class="toggle-content" style="display:none">
    <p>é’“é±¼ä¸ä»…æ˜¯ä¸€ç§ä¼‘é—²æ´»åŠ¨ï¼Œæ›´è•´å«ç€ä¸°å¯Œçš„è‡ªç„¶çŸ¥è¯†å’ŒæŠ€å·§ã€‚ä¸åŒçš„é±¼ç±»å¯¹æ°´æ¸©ã€æ°´æµã€å…‰ç…§ç­‰æ¡ä»¶ååº”ä¸åŒã€‚
    <br>ğŸ“Œ é²«é±¼æ˜¯å››å­£çš†å¯å‚é’“çš„ç›®æ ‡é±¼ï¼Œå°¤å…¶åœ¨æ˜¥ç§‹æ°´æ¸©é€‚ä¸­æ—¶æ´»è·ƒï¼›è€Œå¤å­£è‰é±¼ã€é’é±¼è¾ƒä¸ºæ´»è·ƒï¼Œå–œé£Ÿç´ é¥µå’Œå«©è‰ã€‚
    <br>ğŸŒ¡ï¸ åˆæ˜¥æ°”æ¸©ä»ä½ï¼Œå»ºè®®é€‰æ‹©ä¸­åˆæ—¶æ®µé’“é±¼ï¼Œé‡‡ç”¨è…¥å‘³æµ“éƒçš„å°é’©ç»†çº¿ï¼›å…¥å¤ååº”é€‰æ‹©æ¸…æ™¨å’Œå‚æ™šå‡ºé’“ï¼Œé¿å¼€é«˜æ¸©æ—¶æ®µã€‚
    <br>ğŸŒ§ï¸ é›¨ååˆæ™´çš„æ—¥å­ï¼Œæ°´ä½“å«æ°§é‡æå‡ï¼Œæ˜¯é²¤é±¼ã€é²«é±¼è§…é£Ÿçš„æ´»è·ƒæœŸã€‚
    <br>ğŸŒ• å‚æ™šæˆ–å¤œé’“é€‚åˆé’“é²¶é±¼ã€é»„é¢¡é±¼ç­‰å¤œè¡Œæ€§é±¼ç§ï¼Œéœ€æ³¨æ„å®‰å…¨é˜²æŠ¤ã€‚</p>
  </div>
</div>
</div>

    <div class="card">
  <h2>ğŸŒŠ ä¸åŒæ°´æƒ…é€‚åˆé±¼ç§ <button onclick="toggleContent(this)">å±•å¼€</button></h2>
  <div class="toggle-content" style="display:none">
    <ul>
      <li>ğŸŒ¾ <strong>é™æ°´ï¼ˆæ¹–æ³Šã€æ°´åº“è¾¹ç¼˜ï¼‰</strong>ï¼šæ°´æµç¼“æ…¢ï¼Œé€‚åˆå‚é’“é²«é±¼ã€é²¤é±¼ã€è‰é±¼ã€‚ä½¿ç”¨è½»æ¼‚ç»†çº¿å¯æœ‰æ•ˆè§‚å¯Ÿé±¼è®¯ã€‚</li>
      <li>ğŸ’¨ <strong>å¾®é£æ°´é¢</strong>ï¼šæ°´ä½“æµåŠ¨è½»å¾®ï¼Œæµ®æ¼‚ç¨³å®šï¼Œé€‚åˆé’“æ´»è·ƒé±¼å¦‚è‰é±¼ã€é²¢é³™ï¼Œå°¤å…¶åœ¨å¤å­£æ—©æ™šæ•ˆæœè¾ƒä½³ã€‚</li>
      <li>ğŸŒŠ <strong>æµé€Ÿé€‚ä¸­æ²³é“</strong>ï¼šæ°´æµå¸¦æ¥æ–°é²œæ°´è´¨ï¼Œé±¼å„¿æ´»è·ƒï¼Œé²¶é±¼ã€é»„é¢¡é±¼ã€é³Šé±¼å¸¸è§äºæ­¤ï¼Œé€‚åˆä½¿ç”¨åº•é’“æ³•ã€‚</li>
      <li>ğŸŒ§ <strong>é›¨åæµ‘æ°´</strong>ï¼šéƒ¨åˆ†é±¼ç±»è­¦æƒ•æ€§é™ä½ï¼Œå¦‚é²¤é±¼ä¼šæ²¿è¾¹æ¸¸åŠ¨è§…é£Ÿï¼Œå¯é€‰æ‹©é¦™è…¥å‘³æµ“çš„é¥µæ–™åŠ å¤§è¯±é’“ã€‚</li>
      <li>ğŸŒ« <strong>é£æµªè¾ƒå¤§æˆ–æ°´ä½“å‰§å˜</strong>ï¼šé±¼ç±»è¶‹äºåº•å±‚æˆ–èº²é¿ï¼Œå»ºè®®æ”¹ç”¨é’“åº•é‡é“…é’“æ³•ï¼Œå‡å°‘æ¼‚æµ®å¹²æ‰°ã€‚</li>
    </ul>
  </div>
</div>
</div>

  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map;
    let userMarker;
    let savedSpots = JSON.parse(localStorage.getItem('fishing_spots') || '[]');
    let spotMarkers = [];

    function saveSpot(lat, lon, time) {
      savedSpots.push({ lat, lon, time });
      localStorage.setItem('fishing_spots', JSON.stringify(savedSpots));
    }

    function deleteSpot(index) {
      savedSpots.splice(index, 1);
      localStorage.setItem('fishing_spots', JSON.stringify(savedSpots));
      map.removeLayer(spotMarkers[index]);
      spotMarkers.splice(index, 1);
      loadSpots();
    }

    function loadSpots() {
      spotMarkers.forEach(marker => map.removeLayer(marker));
      spotMarkers = [];
      savedSpots.forEach((spot, index) => {
        const marker = L.marker([spot.lat, spot.lon], { draggable: false }).addTo(map);
        const popupContent = `ğŸ£ æ”¶è—é’“ç‚¹<br>ğŸ“ ${spot.lat.toFixed(4)}, ${spot.lon.toFixed(4)}<br>ğŸ•’ ${spot.time}<br><button onclick="deleteSpot(${index})">ğŸ—‘ï¸ åˆ é™¤</button>`;
        marker.bindPopup(popupContent);
        spotMarkers.push(marker);
      });
    }

    function initMap(lat, lon) {
      if (!map) {
        map = L.map('map').setView([lat, lon], 13);
        L.tileLayer('https://webrd02.is.autonavi.com/appmaptile?style=7&x={x}&y={y}&z={z}', {
          attribution: '&copy; é«˜å¾·åœ°å›¾',
          subdomains: ['webrd01', 'webrd02', 'webrd03'],
          maxZoom: 18
        }).addTo(map);

        map.on('click', e => {
          const { lat, lng } = e.latlng;
          const now = new Date().toLocaleString();
          const marker = L.marker([lat, lng], { draggable: true }).addTo(map);
          const popupContent = `ğŸ¯ æ–°é’“ç‚¹<br>ğŸ“ ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>ğŸ•’ ${now}`;
          marker.bindPopup(popupContent).openPopup();
          saveSpot(lat, lng, now);
          loadSpots();
        });

        loadSpots();
      }

      if (userMarker) {
        userMarker.setLatLng([lat, lon]);
      } else {
        userMarker = L.marker([lat, lon], { draggable: true })
          .addTo(map)
          .bindPopup("ğŸ“ å½“å‰é’“ç‚¹ï¼ˆå¯æ‹–åŠ¨ï¼‰").openPopup();
      }
    }
  </script>
<script>
const weatherIcons = {
  "æ™´": "â˜€ï¸", "å¤šäº‘": "â›…", "é˜´": "â˜ï¸", "å°é›¨": "ğŸŒ§ï¸", "ä¸­é›¨": "ğŸŒ§ï¸", "å¤§é›¨": "ğŸŒ§ï¸", "é›·é˜µé›¨": "ğŸŒ©ï¸", "é›ª": "â„ï¸"
};

function getFishingTimeSuggestion(temp, weather) {
  if (["å°é›¨", "ä¸­é›¨", "å¤§é›¨", "é›·é˜µé›¨"].includes(weather)) {
    return "å»ºè®®é¿å¼€é™é›¨æ—¶æ®µï¼Œé€‰æ‹©é›¨åœåæˆ–å¤©è‰²æ”¾æ™´å†å‡ºé’“";
  }
  if (temp >= 25) {
    return "æœ€ä½³æ—¶é—´ï¼šæ¸…æ™¨5~8ç‚¹ æˆ– å‚æ™š5~7ç‚¹ï¼Œé¿å…ä¸­åˆé«˜æ¸©";
  }
  if (temp >= 18 && temp < 25) {
    return "å…¨å¤©æ—¶æ®µè¾ƒèˆ’é€‚ï¼Œæ¨èæ—©ä¸Š7~10ç‚¹ã€ä¸‹åˆ3~6ç‚¹å‡ºé’“";
  }
  if (temp >= 10 && temp < 18) {
    return "æ—©æ™šåå‡‰ï¼Œæ¨èä¸­åˆ11~14ç‚¹ä¹‹é—´å‡ºé’“";
  }
  return "æ¸©åº¦è¾ƒä½ï¼Œå»ºè®®é€‰æ‹©ä¸­åˆæ—¶æ®µï¼Œæ³¨æ„ä¿æš–";
}

function getDressSuggestion(temp, weather) {
  const umbrella = ["å°é›¨", "ä¸­é›¨", "å¤§é›¨", "é›·é˜µé›¨"].includes(weather) ? "â˜” è¯·æºå¸¦é›¨å…·ã€‚" : "";
  if (temp >= 28) return `ğŸ‘• ç©¿ç€å»ºè®®ï¼šçŸ­è¢–+é˜²æ™’å¸½ï¼Œæ³¨æ„è¡¥æ°´ã€‚${umbrella}`;
  if (temp >= 20) return `ğŸ§¥ ç©¿ç€å»ºè®®ï¼šè–„å¤–å¥—+é•¿è£¤ï¼Œæ—©æ™šå¾®å‡‰ã€‚${umbrella}`;
  if (temp >= 10) return `ğŸ§£ ç©¿ç€å»ºè®®ï¼šå¤¹å…‹+é•¿è¢–ï¼Œé€‚å½“ä¿æš–ã€‚${umbrella}`;
  return `ğŸ§¥ ç©¿ç€å»ºè®®ï¼šä¿æš–å¤–å¥—+å›´å·¾+å¸½å­ã€‚${umbrella}`;
}

async function getWeather() {
  const dateElem = document.getElementById("date");
  const locationElem = document.getElementById("location");
  const weatherElem = document.getElementById("weather");
  const tempElem = document.getElementById("temp");
  const windElem = document.getElementById("wind");
  const pressureElem = document.getElementById("pressure");
  const adviceElem = document.getElementById("advice");
  const forecastContent = document.getElementById("forecastContent");
  const dressIndexElem = document.getElementById("dressIndex");

  const now = new Date();
  dateElem.innerText = `ğŸ“… æ—¥æœŸï¼š${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()} ï¼ˆæ˜ŸæœŸ${"æ—¥ä¸€äºŒä¸‰å››äº”å…­"[now.getDay()]}ï¼‰`;

  try {
    navigator.geolocation.getCurrentPosition(async position => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      initMap(lat, lon);

      const locationRes = await fetch(`https://geoapi.qweather.com/v2/city/lookup?location=${lon},${lat}&key=cdbc8afd371d4140bf33e52793fc9530`);
      const locationData = await locationRes.json();
      const locationId = locationData.location[0].id;
      const locationName = `${locationData.location[0].adm2} Â· ${locationData.location[0].name}`;

      const nowRes = await fetch(`https://devapi.qweather.com/v7/weather/now?location=${locationId}&key=cdbc8afd371d4140bf33e52793fc9530`);
      const nowData = await nowRes.json();

      const weather = nowData.now.text;
      const temp = parseFloat(nowData.now.temp);
      const wind = parseFloat(nowData.now.windScale);
      const pressure = parseFloat(nowData.now.pressure);

      locationElem.innerText = `ğŸ“ ä½ç½®ï¼š${locationName}`;
      weatherElem.innerText = `ğŸŒ¤ å¤©æ°”ï¼š${weather}`;
      tempElem.innerText = `ğŸŒ¡ æ¸©åº¦ï¼š${temp}â„ƒ`;
      windElem.innerText = `ğŸ’¨ é£åŠ›ï¼š${wind}çº§`;
      pressureElem.innerText = `ğŸ”½ æ°”å‹ï¼š${pressure} hPa`;

      let suggestion = 'âŒ ä»Šæ—¥ä¸é€‚å®œé’“é±¼';
      let method = '';
      if (temp >= 15 && temp <= 28 && wind <= 3 && pressure >= 1005) {
        suggestion = 'âœ… ä»Šæ—¥é€‚å®œé’“é±¼';
        method = temp >= 22 ? 'ğŸˆ æ¨èé’“æµ®' : 'ğŸ¯ æ¨èé’“åº•';
      }

      adviceElem.innerText = `${suggestion}
${method}
${getFishingTimeSuggestion(temp, weather)}`;
      dressIndexElem.innerText = getDressSuggestion(temp, weather);

      const forecastRes = await fetch(`https://devapi.qweather.com/v7/weather/3d?location=${locationId}&key=cdbc8afd371d4140bf33e52793fc9530`);
      const forecastData = await forecastRes.json();

      let forecastHTML = '';
      forecastData.daily.slice(0, 3).forEach(day => {
        const date = day.fxDate;
        const high = parseFloat(day.tempMax);
        const low = parseFloat(day.tempMin);
        const wind = parseFloat(day.windScaleDay);
        const textDay = day.textDay;
        const icon = weatherIcons[textDay] || '';
        const fishable = (high >= 15 && high <= 28 && wind <= 3);
        const method = high >= 22 ? 'ğŸˆ é’“æµ®' : 'ğŸ¯ é’“åº•';
        const timeTip = getFishingTimeSuggestion(high, textDay);
        const dress = getDressSuggestion(high, textDay);
        forecastHTML += `<div class="forecast-day">
          <p>ğŸ“… ${date}ï¼š${fishable ? 'âœ… é€‚å®œ' : 'âŒ ä¸é€‚å®œ'}ï¼Œ${method}</p>
          <p>ğŸŒ¡ ${low}~${high}â„ƒï¼ŒğŸ’¨ é£${wind}çº§ï¼Œ${icon} ${textDay}</p>
          <p>ğŸ•’ ${timeTip}</p>
          <p>ğŸ‘— ${dress}</p>
        </div>`;
      });

      forecastContent.innerHTML = forecastHTML;
    }, () => {
      adviceElem.innerText = 'âš ï¸ æ— æ³•è·å–å®šä½ä¿¡æ¯';
    });
  } catch (error) {
    adviceElem.innerText = 'âš ï¸ è·å–å¤©æ°”å¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
  }
}

getWeather();
function toggleContent(button) {
  const content = button.parentElement.nextElementSibling;
  const isVisible = content.style.display === 'block';
  content.style.display = isVisible ? 'none' : 'block';
  button.innerText = isVisible ? 'å±•å¼€' : 'æ”¶èµ·';
}
</script>
</body>
</html>
